<section class="space-y-6">
  <a routerLink="/owner/bills" class="inline-flex items-center gap-2 text-sm text-primary hover:underline mb-4">
    <mat-icon class="text-base">arrow_back</mat-icon>
    Back to Bills
  </a>

  <div>
    <h1 class="text-3xl font-semibold text-text mb-1">{{ 'owner.bills.create' | t }}</h1>
    <p class="text-sm text-muted">Create a new bill for a customer</p>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="card-form space-y-6">
    <!-- Customer Information -->
    <div class="form-section">
      <div class="form-section-title">Customer Information</div>
      
      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Customer</mat-label>
        <mat-select formControlName="ownerCustomerId" required>
          <mat-option *ngFor="let customer of (customers$ | async)" [value]="customer.id">
            {{ customer.fullName || (customer.firstName + ' ' + customer.lastName) }} Â· {{ customer.subscriptionNumber }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>person</mat-icon>
        <mat-error *ngIf="form.controls.ownerCustomerId.hasError('required')">
          Customer selection is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Name on Bill</mat-label>
        <input matInput formControlName="nameOnBill" placeholder="Leave empty to use default" />
        <mat-icon matPrefix>description</mat-icon>
        <mat-hint>If empty, will use customer's default name on bill</mat-hint>
      </mat-form-field>
    </div>

    <!-- Billing Period -->
    <div class="form-section">
      <div class="form-section-title">Billing Period</div>
      
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Period Year</mat-label>
          <input matInput type="number" formControlName="periodYear" [min]="2020" [max]="2030" required />
          <mat-icon matPrefix>calendar_today</mat-icon>
          <mat-error *ngIf="form.controls.periodYear.hasError('required')">
            Year is required
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Period Month</mat-label>
          <mat-select formControlName="periodMonth" required>
            <mat-option *ngFor="let month of months" [value]="month.value">
              {{ month.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>calendar_month</mat-icon>
          <mat-error *ngIf="form.controls.periodMonth.hasError('required')">
            Month is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Bill Date</mat-label>
          <input matInput type="date" formControlName="billDate" [value]="today" required />
          <mat-icon matPrefix>event</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Due Date</mat-label>
          <input matInput type="date" formControlName="dueDate" />
          <mat-icon matPrefix>event_available</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <!-- Meter Readings -->
    <div class="form-section" *ngIf="getSelectedCustomer()?.billingMode === 'METERED'">
      <div class="form-section-title">Meter Readings (KVA)</div>
      
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Previous KVA</mat-label>
          <input matInput type="number" step="0.01" formControlName="previousKva" />
          <mat-icon matPrefix>speed</mat-icon>
          <mat-hint>Previous meter reading</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Current KVA</mat-label>
          <input matInput type="number" step="0.01" formControlName="currentKva" />
          <mat-icon matPrefix>flash_on</mat-icon>
          <mat-hint>Current meter reading</mat-hint>
        </mat-form-field>
      </div>

      <div class="rounded-soft border border-primary/20 bg-primary/5 p-4" *ngIf="getKvaDifference() !== null">
        <div class="text-sm font-semibold text-text">Usage: {{ getKvaDifference() | number: '1.2-2' }} KVA</div>
      </div>
    </div>

    <!-- Billing Calculation -->
    <div class="form-section">
      <div class="form-section-title">Billing Calculation</div>
      
      <div class="form-grid">
        <mat-form-field appearance="outline" *ngIf="getSelectedCustomer()?.billingMode === 'METERED'">
          <mat-label>Subscription Fee (Variable) per KVA</mat-label>
          <input matInput type="number" step="0.01" formControlName="subscriptionFeeVar" />
          <mat-icon matPrefix>calculate</mat-icon>
          <mat-hint>Rate per KVA</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Subscription Fee (Fixed)</mat-label>
          <input matInput type="number" step="0.01" formControlName="subscriptionFeeFixed" />
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-hint>Flat fee amount</mat-hint>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Total Amount (USD)</mat-label>
        <input matInput type="number" step="0.01" formControlName="totalAmount" required />
        <mat-icon matPrefix>payments</mat-icon>
        <mat-error *ngIf="form.controls.totalAmount.hasError('required')">
          Total amount is required
        </mat-error>
      </mat-form-field>

      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Amount (USD)</mat-label>
          <input matInput type="number" step="0.01" formControlName="amountUSD" />
          <mat-icon matPrefix>attach_money</mat-icon>
          <mat-hint>Optional: specify USD amount separately</mat-hint>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Amount (LBP)</mat-label>
          <input matInput type="number" formControlName="amountLBP" />
          <mat-icon matPrefix>currency_lira</mat-icon>
          <mat-hint>Optional: LBP equivalent</mat-hint>
        </mat-form-field>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="form-section">
      <div class="form-section-title">Additional Information</div>
      
      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Subscription Amps</mat-label>
        <input matInput type="number" step="0.01" formControlName="subscriptionAmps" />
        <mat-icon matPrefix>bolt</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Notes</mat-label>
        <textarea matInput formControlName="notes" rows="3" placeholder="Additional notes or comments"></textarea>
        <mat-icon matPrefix>notes</mat-icon>
      </mat-form-field>
    </div>

    <!-- Amount Summary -->
    <div class="rounded-soft border border-primary/20 bg-primary/5 p-6" *ngIf="totals$ | async as totals">
      <div class="text-sm font-semibold text-text mb-4">Amount Summary</div>
      <div class="grid gap-3 md:grid-cols-2">
        <div class="flex justify-between items-center">
          <span class="text-muted">Total Amount:</span>
          <span class="text-lg font-bold text-text">{{ totals.totalAmount | number: '1.2-2' }} USD</span>
        </div>
        <div class="flex justify-between items-center" *ngIf="totals.amountLBP">
          <span class="text-muted">LBP Equivalent:</span>
          <span class="text-lg font-bold text-text">{{ totals.amountLBP | number }} LBP</span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button mat-stroked-button type="button" (click)="cancel()">
        Cancel
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || submitting">
        <mat-spinner *ngIf="submitting" diameter="20" class="inline-block mr-2"></mat-spinner>
        <mat-icon *ngIf="!submitting">save</mat-icon>
        <span class="ml-2">{{ submitting ? 'Creating...' : ('common.actions.save' | t) }}</span>
      </button>
    </div>
  </form>
</section>
