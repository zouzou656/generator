<section class="space-y-6">
  <a routerLink="/owner/bills" class="inline-flex items-center gap-2 text-sm text-primary hover:underline mb-4">
    <mat-icon class="text-base">arrow_back</mat-icon>
    Back to Bills
  </a>

  <div>
    <h1 class="text-3xl font-semibold text-text mb-1">{{ 'owner.bills.create' | t }}</h1>
    <p class="text-sm text-muted">Create a new bill for a customer</p>
  </div>

  <form [formGroup]="form" (ngSubmit)="submit()" class="card-form space-y-6">
    <!-- Customer Information -->
    <div class="form-section">
      <div class="form-section-title">Customer Information</div>
      
      <mat-form-field appearance="outline" class="form-field-full">
        <mat-label>Customer</mat-label>
        <mat-select formControlName="ownerCustomerId" required>
          <mat-option *ngFor="let customer of (customers$ | async)" [value]="customer.id">
            {{ customer.fullName || (customer.firstName + ' ' + customer.lastName) }} Â· {{ customer.subscriptionNumber }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>person</mat-icon>
        <mat-error *ngIf="form.controls.ownerCustomerId.hasError('required')">
          Customer selection is required
        </mat-error>
      </mat-form-field>

      <div class="custom-input-container">
        <div class="custom-input-wrapper">
          <div class="custom-input-label">
            <span class="label-text">Name on Bill</span>
          </div>
          <input 
            type="text" 
            class="custom-input" 
            formControlName="nameOnBill" 
            placeholder="Leave empty to use default"
          />
        </div>
        <div class="text-xs text-muted mt-1 pl-1">If empty, will use customer's default name on bill</div>
      </div>
    </div>

    <!-- Billing Period -->
    <div class="form-section">
      <div class="form-section-title">Billing Period</div>
      
      <div class="form-grid">
        <div class="custom-input-container">
          <div class="custom-input-wrapper" [class.error]="form.controls.periodYear.touched && form.controls.periodYear.invalid">
            <div class="custom-input-label">
              <span class="label-text">Period Year<span class="required-asterisk">*</span></span>
            </div>
            <input 
              type="number" 
              class="custom-input" 
              formControlName="periodYear" 
              [min]="2020" 
              [max]="2030"
            />
          </div>
          <div class="custom-error" *ngIf="form.controls.periodYear.touched && form.controls.periodYear.hasError('required')">
            Year is required
          </div>
        </div>

        <mat-form-field appearance="outline">
          <mat-label>Period Month</mat-label>
          <mat-select formControlName="periodMonth" required>
            <mat-option *ngFor="let month of months" [value]="month.value">
              {{ month.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>calendar_month</mat-icon>
          <mat-error *ngIf="form.controls.periodMonth.hasError('required')">
            Month is required
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-grid">
        <div class="custom-input-container">
          <div class="custom-input-wrapper" [class.error]="form.controls.billDate.touched && form.controls.billDate.invalid">
            <div class="custom-input-label">
              <span class="label-text">Bill Date<span class="required-asterisk">*</span></span>
            </div>
            <input 
              type="date" 
              class="custom-input" 
              formControlName="billDate" 
              [value]="today"
            />
          </div>
          <div class="custom-error" *ngIf="form.controls.billDate.touched && form.controls.billDate.hasError('required')">
            Bill date is required
          </div>
        </div>

        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Due Date</span>
            </div>
            <input 
              type="date" 
              class="custom-input" 
              formControlName="dueDate" 
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Meter Readings -->
    <div class="form-section" *ngIf="getSelectedCustomer()?.billingMode === 'METERED'">
      <div class="form-section-title">Meter Readings (KVA)</div>
      
      <div class="form-grid">
        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Previous KVA</span>
            </div>
            <input 
              type="number" 
              step="0.01"
              class="custom-input" 
              formControlName="previousKva" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Previous meter reading</div>
        </div>

        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Current KVA</span>
            </div>
            <input 
              type="number" 
              step="0.01"
              class="custom-input" 
              formControlName="currentKva" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Current meter reading</div>
        </div>
      </div>

      <div class="rounded-soft border border-primary/20 bg-primary/5 p-4" *ngIf="getKvaDifference() !== null">
        <div class="text-sm font-semibold text-text">Usage: {{ getKvaDifference() | number: '1.2-2' }} KVA</div>
      </div>
    </div>

    <!-- Billing Calculation -->
    <div class="form-section">
      <div class="form-section-title">Billing Calculation</div>
      
      <div class="form-grid">
        <div class="custom-input-container" *ngIf="getSelectedCustomer()?.billingMode === 'METERED'">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Subscription Fee (Variable) per KVA</span>
            </div>
            <input 
              type="number" 
              step="0.01"
              class="custom-input" 
              formControlName="subscriptionFeeVar" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Rate per KVA</div>
        </div>

        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Subscription Fee (Fixed)</span>
            </div>
            <input 
              type="number" 
              step="0.01"
              class="custom-input" 
              formControlName="subscriptionFeeFixed" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Flat fee amount</div>
        </div>
      </div>

      <div class="custom-input-container">
        <div class="custom-input-wrapper" [class.error]="form.controls.totalAmount.touched && form.controls.totalAmount.invalid">
          <div class="custom-input-label">
            <span class="label-text">Total Amount (USD)<span class="required-asterisk">*</span></span>
          </div>
          <input 
            type="number" 
            step="0.01"
            class="custom-input" 
            formControlName="totalAmount" 
          />
        </div>
        <div class="custom-error" *ngIf="form.controls.totalAmount.touched && form.controls.totalAmount.hasError('required')">
          Total amount is required
        </div>
      </div>

      <div class="form-grid">
        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Amount (USD)</span>
            </div>
            <input 
              type="number" 
              step="0.01"
              class="custom-input" 
              formControlName="amountUSD" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Optional: specify USD amount separately</div>
        </div>

        <div class="custom-input-container">
          <div class="custom-input-wrapper">
            <div class="custom-input-label">
              <span class="label-text">Amount (LBP)</span>
            </div>
            <input 
              type="number" 
              class="custom-input" 
              formControlName="amountLBP" 
            />
          </div>
          <div class="text-xs text-muted mt-1 pl-1">Optional: LBP equivalent</div>
        </div>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="form-section">
      <div class="form-section-title">Additional Information</div>
      
      <div class="custom-input-container">
        <div class="custom-input-wrapper">
          <div class="custom-input-label">
            <span class="label-text">Subscription Amps</span>
          </div>
          <input 
            type="number" 
            step="0.01"
            class="custom-input" 
            formControlName="subscriptionAmps" 
          />
        </div>
      </div>

      <div class="custom-input-container">
        <div class="custom-input-wrapper">
          <div class="custom-input-label">
            <span class="label-text">Notes</span>
          </div>
          <textarea 
            class="custom-input" 
            formControlName="notes"
            rows="3" 
            placeholder="Additional notes or comments"
            style="resize: vertical; min-height: 100px;"
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Amount Summary -->
    <div class="rounded-soft border border-primary/20 bg-primary/5 p-6" *ngIf="totals$ | async as totals">
      <div class="text-sm font-semibold text-text mb-4">Amount Summary</div>
      <div class="grid gap-3 md:grid-cols-2">
        <div class="flex justify-between items-center">
          <span class="text-muted">Total Amount:</span>
          <span class="text-lg font-bold text-text">{{ totals.totalAmount | number: '1.2-2' }} USD</span>
        </div>
        <div class="flex justify-between items-center" *ngIf="totals.amountLBP">
          <span class="text-muted">LBP Equivalent:</span>
          <span class="text-lg font-bold text-text">{{ totals.amountLBP | number }} LBP</span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button mat-stroked-button type="button" (click)="cancel()">
        Cancel
      </button>
      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || submitting">
        <mat-spinner *ngIf="submitting" diameter="20" class="inline-block mr-2"></mat-spinner>
        <mat-icon *ngIf="!submitting">save</mat-icon>
        <span class="ml-2">{{ submitting ? 'Creating...' : ('common.actions.save' | t) }}</span>
      </button>
    </div>
  </form>
</section>
