<section class="space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-semibold text-text">{{ 'owner.sms.templates.title' | t }}</h1>
      <p class="text-sm text-muted mt-1">Create reusable SMS message templates with placeholders</p>
    </div>
    <div class="flex gap-2">
      <button 
        mat-stroked-button 
        routerLink="/owner/sms/templates/preview"
        *ngIf="templates.length > 0"
      >
        <mat-icon>preview</mat-icon>
        <span class="ml-2">Preview</span>
      </button>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="form.reset(); editingId = null"
      >
        <mat-icon>add</mat-icon>
        <span class="ml-2">New Template</span>
      </button>
    </div>
  </div>

  <!-- Create/Edit Form -->
  <div class="card-form" *ngIf="!editingId || form.value.name">
    <div class="form-section">
      <div class="form-section-title">
        {{ editingId ? 'Edit Template' : 'Create New Template' }}
      </div>
      
      <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4">
        <div class="custom-input-container">
          <div class="custom-input-wrapper" [class.error]="form.controls.name.touched && form.controls.name.invalid">
            <div class="custom-input-label">
              <span class="label-text">Template Name<span class="required-asterisk">*</span></span>
            </div>
            <input 
              type="text" 
              class="custom-input" 
              formControlName="name" 
              placeholder="e.g., Payment Reminder"
            />
          </div>
          <div class="custom-error" *ngIf="form.controls.name.touched && form.controls.name.hasError('required')">
            Template name is required
          </div>
        </div>

        <div class="custom-input-container">
          <div class="custom-input-wrapper" [class.error]="form.controls.body.touched && form.controls.body.invalid">
            <div class="custom-input-label">
              <span class="label-text">Message Body<span class="required-asterisk">*</span></span>
            </div>
            <textarea 
              class="custom-input" 
              rows="6" 
              formControlName="body" 
              placeholder="Enter your SMS message..."
              style="resize: vertical; min-height: 140px;"
            ></textarea>
          </div>
          <div class="text-xs space-y-1 mt-1 pl-1">
            <div class="text-muted">Available placeholders: {{ '{{name}}' }}, {{ '{{amount}}' }}, {{ '{{period}}' }}, {{ '{{dueDate}}' }}, {{ '{{subscriptionNumber}}' }}</div>
            <div class="text-muted">Character count: {{ form.value.body?.length || 0 }} / 160</div>
          </div>
          <div class="custom-error" *ngIf="form.controls.body.touched && form.controls.body.hasError('required')">
            Message body is required
          </div>
          <div class="custom-error" *ngIf="form.controls.body.touched && form.controls.body.hasError('minlength')">
            Message must be at least 10 characters
          </div>
        </div>

        <!-- Placeholder Helper -->
        <div class="rounded-soft border border-primary/20 bg-primary/5 p-4">
          <div class="text-sm font-semibold text-text mb-2">Available Placeholders</div>
          <div class="flex flex-wrap gap-2">
            <button 
              type="button"
              mat-stroked-button 
              size="small"
              *ngFor="let placeholder of placeholders"
              (click)="insertPlaceholder(placeholder)"
              class="text-xs"
            >
              {{ '{{' + placeholder + '}}' }}
            </button>
          </div>
        </div>

        <!-- Preview -->
        <div class="rounded-soft border border-white/10 bg-surface/50 p-4" *ngIf="form.value.body">
          <div class="text-xs font-semibold text-muted mb-2">Preview</div>
          <div class="bg-surface p-3 rounded-soft border border-white/10 min-h-[60px] text-sm">
            <div class="whitespace-pre-wrap">{{ getPreviewText() }}</div>
          </div>
        </div>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="cancel()">
            Cancel
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || loading">
            <mat-spinner *ngIf="loading" diameter="20" class="inline-block mr-2"></mat-spinner>
            <mat-icon *ngIf="!loading">{{ editingId ? 'save' : 'add' }}</mat-icon>
            <span class="ml-2">{{ editingId ? 'Update Template' : 'Create Template' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Templates Grid -->
  <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" *ngIf="templates.length > 0; else empty">
    <article 
      *ngFor="let template of templates" 
      class="rounded-soft border border-white/10 bg-surface/95 p-6 shadow-soft hover:shadow-lg hover:border-primary/30 transition-all"
    >
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-text mb-1">{{ template.name }}</h2>
          <p class="text-xs text-muted">Updated {{ template.updatedAt | date: 'short' }}</p>
        </div>
        <button mat-icon-button [matMenuTriggerFor]="menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button mat-menu-item routerLink="/owner/sms/templates/preview" [queryParams]="{templateId: template.id}">
            <mat-icon>preview</mat-icon>
            <span>Preview</span>
          </button>
          <button mat-menu-item (click)="edit(template)">
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button mat-menu-item (click)="duplicate(template)">
            <mat-icon>content_copy</mat-icon>
            <span>Duplicate</span>
          </button>
          <button mat-menu-item (click)="delete(template.id)" class="text-danger">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>
      </div>
      
      <div class="bg-surface/50 p-3 rounded-soft mb-4">
        <p class="whitespace-pre-wrap text-sm text-muted line-clamp-3">{{ template.body }}</p>
      </div>
      
      <div class="flex items-center gap-2 text-xs text-muted">
        <mat-icon class="text-xs">textsms</mat-icon>
        <span>{{ template.body.length }} characters</span>
        <span class="mx-1">â€¢</span>
        <span>{{ Math.ceil(template.body.length / 160) }} SMS</span>
      </div>
    </article>
  </div>

  <ng-template #empty>
    <div class="rounded-soft border border-white/10 bg-surface/90 px-8 py-12 text-center">
      <mat-icon class="text-6xl text-muted mb-4">message</mat-icon>
      <h3 class="text-lg font-semibold text-text mb-2">No templates yet</h3>
      <p class="text-sm text-muted mb-6">Create your first SMS template to get started</p>
      <button mat-raised-button color="primary" (click)="form.reset(); editingId = null">
        <mat-icon>add</mat-icon>
        <span class="ml-2">Create Template</span>
      </button>
    </div>
  </ng-template>
</section>
