<section class="space-y-6">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h1 class="text-3xl font-semibold text-text">{{ 'owner.sms.campaigns.title' | t }}</h1>
      <p class="text-sm text-muted mt-1">Create and manage SMS campaigns for your customers</p>
    </div>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      <span class="ml-2">{{ 'owner.sms.campaigns.create' | t }}</span>
    </button>
  </div>

  <!-- Campaign Form -->
  <div class="card-form" *ngIf="showForm">
    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4">
      <div class="form-section">
        <div class="form-section-title">Campaign Details</div>
        
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>Campaign Title</mat-label>
          <input matInput formControlName="title" placeholder="e.g., March Payment Reminders" required />
          <mat-icon matPrefix>campaign</mat-icon>
          <mat-error *ngIf="form.controls.title.hasError('required')">
            Campaign title is required
          </mat-error>
        </mat-form-field>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Message Template</mat-label>
            <mat-select formControlName="templateId" required>
              <mat-option *ngFor="let template of templates" [value]="template.id">
                {{ template.name }}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>message</mat-icon>
            <mat-hint>Select a template or create a new one</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Related Period Year</mat-label>
            <input matInput type="number" formControlName="relatedPeriodYear" [min]="2020" [max]="2030" />
            <mat-icon matPrefix>calendar_today</mat-icon>
            <mat-hint>Optional: Link to billing period</mat-hint>
          </mat-form-field>
        </div>

        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>Related Period Month</mat-label>
            <mat-select formControlName="relatedPeriodMonth">
              <mat-option value="">None</mat-option>
              <mat-option *ngFor="let month of months" [value]="month.value">
                {{ month.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Schedule Date & Time</mat-label>
            <input matInput type="datetime-local" formControlName="scheduledAt" />
            <mat-icon matPrefix>schedule</mat-icon>
            <mat-hint>Leave empty to send immediately</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Target Customers -->
      <div class="form-section">
        <div class="form-section-title">Target Customers</div>
        
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>Target Segments</mat-label>
          <mat-select formControlName="targetSegments" multiple>
            <mat-option value="ALL_CUSTOMERS">All Active Customers</mat-option>
            <mat-option value="PENDING_BILLS">Customers with Pending Bills</mat-option>
            <mat-option value="OVERDUE_BILLS">Customers with Overdue Bills</mat-option>
            <mat-option value="PAID_BILLS">Customers with Paid Bills (This Period)</mat-option>
          </mat-select>
          <mat-icon matPrefix>group</mat-icon>
          <mat-hint>Select customer segments to target</mat-hint>
        </mat-form-field>

        <!-- Preview Recipients Count -->
        <div class="rounded-soft border border-primary/20 bg-primary/5 p-4" *ngIf="estimatedRecipients() > 0">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm font-semibold text-text">Estimated Recipients</div>
              <div class="text-xs text-muted">{{ estimatedRecipients() }} customers will receive this SMS</div>
            </div>
            <div class="text-2xl font-bold text-primary">{{ estimatedRecipients() }}</div>
          </div>
        </div>
      </div>

      <!-- Message Preview -->
      <div class="form-section" *ngIf="selectedTemplate">
        <div class="form-section-title">Message Preview</div>
        <div class="bg-surface/50 p-4 rounded-soft border border-white/10">
          <div class="text-sm text-muted mb-2">Template: {{ selectedTemplate.name }}</div>
          <div class="whitespace-pre-wrap text-sm">{{ getPreviewMessage() }}</div>
          <div class="text-xs text-muted mt-2">
            {{ selectedTemplate.body.length }} characters · 
            {{ Math.ceil(selectedTemplate.body.length / 160) }} SMS per customer
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button mat-stroked-button type="button" (click)="cancel()">
          Cancel
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || loading">
          <mat-spinner *ngIf="loading" diameter="20" class="inline-block mr-2"></mat-spinner>
          <mat-icon *ngIf="!loading">send</mat-icon>
          <span class="ml-2">{{ form.value.scheduledAt ? 'Schedule Campaign' : 'Send Now' }}</span>
        </button>
      </div>
    </form>
  </div>

  <!-- Campaigns List -->
  <div class="grid gap-4 md:grid-cols-2" *ngIf="campaigns$ | async as campaigns">
    <article 
      *ngFor="let campaign of campaigns" 
      class="rounded-soft border border-white/10 bg-surface/95 p-6 shadow-soft hover:shadow-lg hover:border-primary/30 transition-all"
    >
      <div class="flex items-start justify-between mb-4">
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-text mb-1">{{ campaign.title }}</h2>
          <p class="text-xs text-muted">
            Created {{ campaign.createdAt | date: 'short' }}
            <span *ngIf="campaign.relatedPeriodYear && campaign.relatedPeriodMonth">
              · Period: {{ formatPeriod(campaign.relatedPeriodYear, campaign.relatedPeriodMonth) }}
            </span>
          </p>
        </div>
        <mat-chip [color]="getStatusColor(campaign.status)" selected>
          {{ campaign.status }}
        </mat-chip>
      </div>

      <!-- Metrics -->
      <div class="grid grid-cols-3 gap-3 mb-4 p-3 rounded-soft bg-surface/50">
        <div class="text-center">
          <div class="text-lg font-bold text-success">{{ campaign.metrics?.delivered || 0 }}</div>
          <div class="text-xs text-muted">Delivered</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-bold text-warning">{{ campaign.metrics?.pending || 0 }}</div>
          <div class="text-xs text-muted">Pending</div>
        </div>
        <div class="text-center">
          <div class="text-lg font-bold text-danger">{{ campaign.metrics?.failed || 0 }}</div>
          <div class="text-xs text-muted">Failed</div>
        </div>
      </div>

      <div class="flex gap-2 pt-4 border-t border-white/10">
        <button mat-stroked-button color="primary" (click)="view(campaign.id)" class="flex-1">
          <mat-icon>visibility</mat-icon>
          <span class="ml-1">View Details</span>
        </button>
        <button 
          mat-raised-button 
          color="accent" 
          (click)="send(campaign.id)" 
          *ngIf="campaign.status !== 'SENT'"
        >
          <mat-icon>send</mat-icon>
          <span class="ml-1">Send</span>
        </button>
      </div>
    </article>
  </div>

  <!-- Empty State -->
  <div *ngIf="(campaigns$ | async)?.length === 0" class="rounded-soft border border-white/10 bg-surface/90 px-8 py-12 text-center">
    <mat-icon class="text-6xl text-muted mb-4">campaign</mat-icon>
    <h3 class="text-lg font-semibold text-text mb-2">No campaigns yet</h3>
    <p class="text-sm text-muted mb-6">Create your first SMS campaign to reach your customers</p>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      <span class="ml-2">Create Campaign</span>
    </button>
  </div>
</section>
